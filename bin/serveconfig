#!/bin/sh
cd /etc/openvpn

# This is a very crude hack to help with race conditions, when starting
# the conf generator and the conf server at the same time. See #19.
sleep 1

[ -f placeholder ] || {
    echo "Please run the OpenVPN container at least once in normal mode,"
    echo "to generate the client configuration file. Thank you."
    exit 1
}

while ! [ -f client.http ]; do
    echo "Waiting for the other container to generate keys and config..."
    sleep 3
done

MY_IP_ADDR=$(curl -s http://myip.enix.org/REMOTE_ADDR)
[ "$MY_IP_ADDR" ] || {
    MY_IP_ADDR=$(curl -s ifconfig.co)
    [ "$MY_IP_ADDR" ] || {
        echo "Sorry, I could not figure out my public IP address."
        echo "(I use http://myip.enix.org/REMOTE_ADDR/ and ifconfig.co for that purpose.)"
        exit 1
    }
}

echo "https://$MY_IP_ADDR:8080/"
socat -d -d \
    OPENSSL-LISTEN:8080,reuseaddr,key=key.pem,certificate=cert.pem,verify=0 \
    EXEC:'cat client.http' \
    2>> http8080.log

socat TCP-LISTEN:84443,bind=127.0.0.1,fork,reuseaddr TCP:www.deere.com:443