#!/bin/sh

CLOACK_REDIRECT_HOST="$1"
if [ -z $CLOACK_REDIRECT_HOST ]
then
    CLOACK_REDIRECT_HOST="http://www.deere.com"
fi

mkdir /tmp/cloack && cd /tmp/cloack

openssl genrsa -out traktor.key 2048
openssl req -new -key traktor.key -out traktor.csr -subj /CN=Traktor/
openssl x509 -req -days 365 -in traktor.csr -signkey traktor.key -out traktor.crt
cat traktor.key traktor.crt >> traktor.pem

[ -f ha.conf ] || cat >ha.conf <<EOF
frontend scramblesuit
    bind  *:80
    mode tcp
    use_backend scramblesuit

frontend cloack
    bind 127.0.0.1:4443 ssl crt traktor.pem
    mode http
    redirect code 301 location $CLOACK_REDIRECT_HOST
backend scramblesuit
    server ssuit 127.0.0.1:8888
EOF
haproxy -f ha.conf &
mkdir /tmp/scramblesuit/ && cd /tmp/scramblesuit/
obfsproxy --log-min-severity info --data-dir=/tmp scramblesuit --password KJHVGS2PJVHECRC2J5JFGT2TIFKDCMRS  --dest 127.0.0.1:443 server 127.0.0.1:8888