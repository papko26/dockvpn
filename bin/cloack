#!/bin/sh

TRAKTOR_HOST="$1"
if [ -z $TRAKTOR_HOST ]
then
    TRAKTOR_HOST="http://www.deere.com"
fi

mkdir /tmp/cloack && cd /tmp/cloack

openssl genrsa -out traktor.key 2048
openssl req -new -key traktor.key -out traktor.csr -subj /CN=traktor.papko.org/
openssl x509 -req -days 365 -in traktor.csr -signkey traktor.key -out traktor.crt
bash -c 'cat traktor.key traktor.crt >> traktor.pem'

[ -f ha.conf ] || cat >ha.conf <<EOF
frontend unsecured
    bind  *:80
    mode http
    redirect code 301 location $TRAKTOR_HOST

frontend  http-in
    bind 127.0.0.1:4443 ssl crt traktor.pem
    mode http
    redirect code 301 location $TRAKTOR_HOST 
EOF
haproxy -f ha.conf