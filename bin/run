#!/bin/sh
set -e

[ -d /dev/net ] ||
    mkdir -p /dev/net
[ -c /dev/net/tun ] ||
    mknod /dev/net/tun c 10 200


SERVER_DNS_NAME="$1"
SERVER_IP=$(curl -s ifconfig.co)

if [ -z $SERVER_DNS_NAME ]
then
    VPN_ADDR=$SERVER_IP
else
    DNS_IP=$(host $SERVER_DNS_NAME | awk '{print $4}')
    if [ "$DNS_IP" == $SERVER_IP ]
        then
        VPN_ADDR=$SERVER_DNS_NAME
    else
        echo "DNS IP AND LISTEN IP DISMATCHED, FALLING BACK TO IP ADDR"
        VPN_ADDR=$SERVER_IP
    fi
fi

CLOACK_REDIRECT_HOST="$2"

cd /etc/openvpn
# This file tells `serveconfig` that there is a config there
[ -f dh.pem ] ||
    openssl dhparam -out dh.pem 1024
[ -f key.pem ] ||
    openssl genrsa -out key.pem 2048
chmod 600 key.pem
[ -f csr.pem ] ||
    openssl req -new -key key.pem -out csr.pem -subj /CN=$VPN_ADDR/
[ -f cert.pem ] ||
    openssl x509 -req -in csr.pem -out cert.pem -signkey key.pem -days 24855

[ -f tcp443.conf ] || cat >tcp443.conf <<EOF
server 192.168.255.0 255.255.255.128
verb 0
duplicate-cn
key key.pem
ca cert.pem
cert cert.pem
dh dh.pem
keepalive 10 60
persist-key
persist-tun
push "dhcp-option DNS 8.8.8.8"
push "dhcp-option DNS 8.8.4.4"

proto tcp-server
port 443
port-share 127.0.0.1 4443
dev tun443
status openvpn-status-443.log
EOF


[ -f client.ovpn ] || cat >client.ovpn <<EOF
client
nobind
dev tun
redirect-gateway def1

<key>
`cat key.pem`
</key>
<cert>
`cat cert.pem`
</cert>
<ca>
`cat cert.pem`
</ca>
<dh>
`cat dh.pem`
</dh>

<connection>
remote $VPN_ADDR 443 tcp-client
</connection>
EOF


iptables -t nat -A POSTROUTING -s 192.168.255.0/24 -o eth0 -j MASQUERADE

touch tcp443.log

while true ; do bash cloack $CLOACK_REDIRECT_HOST ; done &
while true ; do openvpn tcp443.conf ; done


